# Dockerfile for vllm-router with Python CLI wrapper
# This extends the Rust build to include the full Python package with CLI support

FROM rustlang/rust:nightly-bullseye as rust-builder

# Install system dependencies including Python for wheel build
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    python3 \
    python3-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install pip
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3

# Set working directory
WORKDIR /app

# Copy all source files
COPY Cargo.toml Cargo.lock ./
COPY src ./src
COPY build.rs ./
COPY py_src ./py_src
COPY pyproject.toml setup.py README.md ./

# Build the Rust binary
RUN cargo build --release

# Build the Python wheel (this will use the Rust compiler available here)
RUN python3 -m pip install --no-cache-dir setuptools-rust wheel build && \
    python3 -m build

# Python stage with Python CLI
FROM python:3.9-slim-bullseye

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy the pre-built wheel from builder stage
COPY --from=rust-builder /app/dist/*.whl /tmp/

# Install the wheel
RUN pip install /tmp/*.whl && rm /tmp/*.whl

# Expose default router port
EXPOSE 30000

# Expose default metrics port
EXPOSE 29000

# Default command to run the router using Python CLI (full argument support)
ENTRYPOINT ["vllm-router"]
CMD []
